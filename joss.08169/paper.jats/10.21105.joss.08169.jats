<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE article PUBLIC "-//NLM//DTD JATS (Z39.96) Journal Publishing DTD v1.2 20190208//EN"
                  "JATS-publishing1.dtd">
<article xmlns:mml="http://www.w3.org/1998/Math/MathML" xmlns:xlink="http://www.w3.org/1999/xlink" dtd-version="1.2" article-type="other">
<front>
<journal-meta>
<journal-id></journal-id>
<journal-title-group>
<journal-title>Journal of Open Source Software</journal-title>
<abbrev-journal-title>JOSS</abbrev-journal-title>
</journal-title-group>
<issn publication-format="electronic">2475-9066</issn>
<publisher>
<publisher-name>Open Journals</publisher-name>
</publisher>
</journal-meta>
<article-meta>
<article-id pub-id-type="publisher-id">8169</article-id>
<article-id pub-id-type="doi">10.21105/joss.08169</article-id>
<title-group>
<article-title>reflectorch: a deep learning package for X-ray and
neutron reflectometry</article-title>
</title-group>
<contrib-group>
<contrib contrib-type="author" equal-contrib="yes">
<contrib-id contrib-id-type="orcid">https://orcid.org/0000-0002-5897-3863</contrib-id>
<name>
<surname>Munteanu</surname>
<given-names>Valentin</given-names>
</name>
<xref ref-type="aff" rid="aff-1"/>
</contrib>
<contrib contrib-type="author" equal-contrib="yes">
<contrib-id contrib-id-type="orcid">https://orcid.org/0000-0003-4533-6256</contrib-id>
<name>
<surname>Starostin</surname>
<given-names>Vladimir</given-names>
</name>
<xref ref-type="aff" rid="aff-2"/>
</contrib>
<contrib contrib-type="author">
<contrib-id contrib-id-type="orcid">https://orcid.org/0000-0001-8152-6386</contrib-id>
<name>
<surname>Hinderhofer</surname>
<given-names>Alexander</given-names>
</name>
<xref ref-type="aff" rid="aff-1"/>
</contrib>
<contrib contrib-type="author">
<contrib-id contrib-id-type="orcid">https://orcid.org/0000-0003-1787-1868</contrib-id>
<name>
<surname>Gerlach</surname>
<given-names>Alexander</given-names>
</name>
<xref ref-type="aff" rid="aff-1"/>
</contrib>
<contrib contrib-type="author">
<contrib-id contrib-id-type="orcid">https://orcid.org/0000-0003-0680-8740</contrib-id>
<name>
<surname>Lapkin</surname>
<given-names>Dmitry</given-names>
</name>
<xref ref-type="aff" rid="aff-1"/>
</contrib>
<contrib contrib-type="author" corresp="yes">
<contrib-id contrib-id-type="orcid">https://orcid.org/0000-0003-3659-6718</contrib-id>
<name>
<surname>Schreiber</surname>
<given-names>Frank</given-names>
</name>
<xref ref-type="aff" rid="aff-1"/>
<xref ref-type="corresp" rid="cor-1"><sup>*</sup></xref>
</contrib>
<aff id="aff-1">
<institution-wrap>
<institution>University of Tübingen, Institute of Applied Physics, Auf
der Morgenstelle 10, 72076 Tübingen, Germany</institution>
</institution-wrap>
</aff>
<aff id="aff-2">
<institution-wrap>
<institution>University of Tübingen, Cluster of Excellence “Machine
learning - new perspectives for science”, Maria-von-Linden-Straße 6,
72076 Tübingen, Germany</institution>
</institution-wrap>
</aff>
</contrib-group>
<author-notes>
<corresp id="cor-1">* E-mail: <email></email></corresp>
</author-notes>
<pub-date date-type="pub" publication-format="electronic" iso-8601-date="2024-06-01">
<day>1</day>
<month>6</month>
<year>2024</year>
</pub-date>
<volume>10</volume>
<issue>115</issue>
<fpage>8169</fpage>
<permissions>
<copyright-statement>Authors of papers retain copyright and release the
work under a Creative Commons Attribution 4.0 International License (CC
BY 4.0)</copyright-statement>
<copyright-year>2025</copyright-year>
<copyright-holder>The article authors</copyright-holder>
<license license-type="open-access" xlink:href="https://creativecommons.org/licenses/by/4.0/">
<license-p>Authors of papers retain copyright and release the work under
a Creative Commons Attribution 4.0 International License (CC BY
4.0)</license-p>
</license>
</permissions>
<kwd-group kwd-group-type="author">
<kwd>Python</kwd>
<kwd>Pytorch</kwd>
<kwd>machine learning</kwd>
<kwd>surface scattering physics</kwd>
<kwd>reflectometry</kwd>
</kwd-group>
</article-meta>
</front>
<body>
<sec id="summary">
  <title>Summary</title>
  <p>We introduce <monospace>reflectorch</monospace>, a Python package
  which facilitates the full machine learning pipeline for the data
  domain of X-ray and neutron reflectometry. Firstly, the package allows
  the choice of different parameterizations of the scattering length
  density profile of a thin film, or generally, a layered structure, and
  the sampling of the ground truth physical parameters from user-defined
  ranges. Secondly, the package provides functionality for the fast
  simulation of reflectometry curves on the GPU using a vectorized
  implementation of the Abelès matrix formalism
  (<xref alt="Abelès, 1950" rid="ref-Abeles1950" ref-type="bibr">Abelès,
  1950</xref>) and the augmentation of the theoretical curves with noise
  informed by experimental considerations. The architecture of the
  neural network as well as the training callbacks and hyperparameters
  can be easily customized from YAML configuration files. Notably, our
  implementation makes use of a special training procedure introduced in
  our publication
  (<xref alt="Munteanu et al., 2024" rid="ref-Munteanu2024" ref-type="bibr">Munteanu
  et al., 2024</xref>), in which prior boundaries for the target
  parameters are provided alongside the reflectivity curve as an
  additional input to the neural network.</p>
</sec>
<sec id="statement-of-need">
  <title>Statement of need</title>
  <p>X-ray and neutron reflectometry (XRR and NR) are widely-used and
  indispensable experimental techniques for analyzing the structure of
  interfaces and thin films, i.e. layered systems. Experimentalists,
  having measured a reflectometry curve, are faced with the task of
  obtaining the physical parameters corresponding to a parameterization
  of the scattering length density (SLD) profile along the depth of the
  investigated sample. The inverse problem is non-trivial and generally
  ambiguous due to the lack of phase information and experimental
  limitations. Recent years have seen an increased interest in the fast
  analysis of reflectometry data using machine learning techniques, as
  such methods could be adapted for real-time investigations at large
  scale facilities (i.e. synchrotron and neutron sources), enabling
  closed loop experiments
  (<xref alt="Pithan et al., 2023" rid="ref-Pithan2023" ref-type="bibr">Pithan
  et al., 2023</xref>).</p>
  <p>Our contribution to the open-source scientific software community
  is <monospace>reflectorch</monospace>, a deep learning package built
  in the Pytorch framework, which has a modular, object-oriented and
  customizable design. Reflectorch enables the user to simulate
  reflectivity curves in a fast and vectorized manner which takes
  advantage of the computing power of modern GPUs. The neural network
  architecture as well as the training callbacks and hyperparameters can
  be easily customized by editing YAML configuration files. As a result
  of the special training procedure, which incorporates minimum and
  maximum prior bounds for the parameters as described in Munteanu et
  al.
  (<xref alt="2024" rid="ref-Munteanu2024" ref-type="bibr">2024</xref>),
  the user is able to make use of prior knowledge about the investigated
  sample at inference time.</p>
</sec>
<sec id="general-workflow">
  <title>General workflow</title>
  <p>Different types of parameterizations of the SLD profile can be
  represented as subclasses of the
  <monospace>ParametricModel</monospace> class. The parameters are
  represented as an instance of the <monospace>BasicParams</monospace>
  class, which encapsulates the parameter values and their prior bounds,
  also taking care of scaling these values to neural-network friendly
  ranges. The prior sampler is responsible for sampling the values of
  the parameters and their prior bounds from their predefined ranges, in
  which a subclass of <monospace>SamplingStrategy</monospace> can be
  used to further restrict the values of some parameters with respect to
  others. Based on the sampled parameters and on the momentum transfer
  (q) values generated by a subclass of
  <monospace>QGenerator</monospace>, batches of reflectivity curves are
  simulated. The reflectivity curves are further augmented with
  experimentally-informed noise provided by a subclass of
  <monospace>IntensityNoiseGenerator</monospace> and scaled to a neural
  network-friendly range by a subclass of
  <monospace>CurvesScaler</monospace>.</p>
  <p>The trainer encapsulates the data loader, the Pytorch optimizer,
  the neural network, and other training hyperparameters, allowing the
  seamless training of the model and the saving of the resulting model
  weights and of the history of losses and learning rates. The neural
  network architecture consists of an embedding network for the
  reflectivity curves and a multilayer perceptron, components which can
  be flexibly customized. Callback objects can be used to control the
  training process, such as scheduling the learning rate or periodically
  saving the model weights.</p>
  <p>Finally, the <monospace>EasyInferenceModel</monospace> class serves
  as a wrapper around trained models, simplifying the inference step. It
  also provides functionality for automatically downloading model
  weights and configuration files not locally available from a remote
  Hugging Face repository.</p>
</sec>
<sec id="related-work">
  <title>Related Work</title>
  <p>There are several well-established packages designed for the
  conventional analysis of X-ray and neutron reflectometry data such as
  <monospace>GenX</monospace>
  (<xref alt="Glavic &amp; Björck, 2022" rid="ref-GlaviGenX" ref-type="bibr">Glavic
  &amp; Björck, 2022</xref>), <monospace>refnx</monospace>
  (<xref alt="Nelson &amp; Prescott, 2019" rid="ref-NelsonRefnx" ref-type="bibr">Nelson
  &amp; Prescott, 2019</xref>) and <monospace>refl1d</monospace>
  (<xref alt="Maranville et al., 2020" rid="ref-Maranville2020" ref-type="bibr">Maranville
  et al., 2020</xref>). While several machine learning approaches
  pertaining to X-ray or neutron reflectometry have been proposed in
  various publications, <monospace>mlreflect</monospace>
  (<xref alt="Greco et al., 2022" rid="ref-Greco2022Neural" ref-type="bibr">Greco
  et al., 2022</xref>) is the only other properly packaged and
  documented software so far to the best of our knowledge. Previously
  developed in our group, <monospace>mlreflect</monospace> is built in
  the TensorFlow deep learning framework and has limited functionality
  compared to <monospace>reflectorch</monospace> (specifically, the SLD
  profile is limited to a single film). Still, it has been successfully
  adopted for use in the scattering community such as in the publication
  by Schumi-Mareček et al.
  (<xref alt="2024" rid="ref-Schumi-Marecek2024" ref-type="bibr">2024</xref>).
  Notably, <monospace>reflectorch</monospace> can be expanded in
  upcoming releases to incorporate different machine learning methods,
  such as the probabilistic approach proposed in the publication by
  Starostin et al.
  (<xref alt="2025" rid="ref-Starostin2025" ref-type="bibr">2025</xref>).</p>
</sec>
<sec id="acknowledgements">
  <title>Acknowledgements</title>
  <p>The research was part of a project (VIPR 05D23VT1 ERUMDATA) funded
  by the German Federal Ministry for Science and Education (BMBF). This
  work was partly supported by the consortium DAPHNE4NFDI (grant number
  460248799) in the context of the work of the NFDI e.V., funded by the
  German Research Foundation. This project was also funded by the
  Deutsche Forschungsgemeinschaft (DFG, German Research Foundation) –
  project number 557510229. The authors acknowledge the OSCARS project,
  which has received funding from the European Commission’s Horizon
  Europe Research and Innovation program under grant agreement
  101129751. Supported by the Cluster of Excellence “Machine Learning –
  New Perspectives for Science” funded by the German Research Foundation
  under Germany’s Excellence Strategy – reference Number EXC 2064/1 -
  project number 390727645.</p>
</sec>
</body>
<back>
<ref-list>
  <title></title>
  <ref id="ref-Abeles1950">
    <element-citation publication-type="article-journal">
      <person-group person-group-type="author">
        <name><surname>Abelès</surname><given-names>Florin</given-names></name>
      </person-group>
      <article-title>La théorie générale des couches minces</article-title>
      <source>Journal de Physique et le Radium</source>
      <publisher-name>EDP Sciences</publisher-name>
      <year iso-8601-date="1950">1950</year>
      <volume>11</volume>
      <issue>7</issue>
      <pub-id pub-id-type="doi">10.1051/jphysrad:01950001107030700</pub-id>
      <fpage>307</fpage>
      <lpage>309</lpage>
    </element-citation>
  </ref>
  <ref id="ref-Munteanu2024">
    <element-citation publication-type="article-journal">
      <person-group person-group-type="author">
        <name><surname>Munteanu</surname><given-names>Valentin</given-names></name>
        <name><surname>Starostin</surname><given-names>Vladimir</given-names></name>
        <name><surname>Greco</surname><given-names>Alessandro</given-names></name>
        <name><surname>Pithan</surname><given-names>Linus</given-names></name>
        <name><surname>Gerlach</surname><given-names>Alexander</given-names></name>
        <name><surname>Hinderhofer</surname><given-names>Alexander</given-names></name>
        <name><surname>Kowarik</surname><given-names>Stefan</given-names></name>
        <name><surname>Schreiber</surname><given-names>Frank</given-names></name>
      </person-group>
      <article-title>Neural network analysis of neutron and x-ray reflectivity data incorporating prior knowledge</article-title>
      <source>Journal of Applied Crystallography</source>
      <publisher-name>International Union of Crystallography (IUCr)</publisher-name>
      <year iso-8601-date="2024-03">2024</year><month>03</month>
      <volume>57</volume>
      <issue>2</issue>
      <issn>1600-5767</issn>
      <pub-id pub-id-type="doi">10.1107/s1600576724002115</pub-id>
    </element-citation>
  </ref>
  <ref id="ref-Pithan2023">
    <element-citation publication-type="article-journal">
      <person-group person-group-type="author">
        <name><surname>Pithan</surname><given-names>Linus</given-names></name>
        <name><surname>Starostin</surname><given-names>Vladimir</given-names></name>
        <name><surname>Mareček</surname><given-names>David</given-names></name>
        <name><surname>Petersdorf</surname><given-names>Lukas</given-names></name>
        <name><surname>Völter</surname><given-names>Constantin</given-names></name>
        <name><surname>Munteanu</surname><given-names>Valentin</given-names></name>
        <name><surname>Jankowski</surname><given-names>Maciej</given-names></name>
        <name><surname>Konovalov</surname><given-names>Oleg</given-names></name>
        <name><surname>Gerlach</surname><given-names>Alexander</given-names></name>
        <name><surname>Hinderhofer</surname><given-names>Alexander</given-names></name>
        <name><surname>Murphy</surname><given-names>Bridget</given-names></name>
        <name><surname>Kowarik</surname><given-names>Stefan</given-names></name>
        <name><surname>Schreiber</surname><given-names>Frank</given-names></name>
      </person-group>
      <article-title>Closing the loop: autonomous experiments enabled by machine-learning-based online data analysis in synchrotron beamline environments</article-title>
      <source>Journal of Synchrotron Radiation</source>
      <year iso-8601-date="2023-11">2023</year><month>11</month>
      <volume>30</volume>
      <issue>6</issue>
      <uri>https://doi.org/10.1107/S160057752300749X</uri>
      <pub-id pub-id-type="doi">10.1107/S160057752300749X</pub-id>
      <fpage>1064</fpage>
      <lpage>1075</lpage>
    </element-citation>
  </ref>
  <ref id="ref-Greco2022Neural">
    <element-citation publication-type="article-journal">
      <person-group person-group-type="author">
        <name><surname>Greco</surname><given-names>Alessandro</given-names></name>
        <name><surname>Starostin</surname><given-names>Vladimir</given-names></name>
        <name><surname>Edel</surname><given-names>Evelyn</given-names></name>
        <name><surname>Munteanu</surname><given-names>Valentin</given-names></name>
        <name><surname>Russegger</surname><given-names>Nadine</given-names></name>
        <name><surname>Dax</surname><given-names>Ingrid</given-names></name>
        <name><surname>Shen</surname><given-names>Chen</given-names></name>
        <name><surname>Bertram</surname><given-names>Florian</given-names></name>
        <name><surname>Hinderhofer</surname><given-names>Alexander</given-names></name>
        <name><surname>Gerlach</surname><given-names>Alexander</given-names></name>
        <name><surname>Schreiber</surname><given-names>Frank</given-names></name>
      </person-group>
      <article-title>Neural network analysis of neutron and x-ray reflectivity data: Automated analysis using mlreflect, experimental errors and feature engineering</article-title>
      <source>J. Appl. Crystallogr.</source>
      <year iso-8601-date="2022">2022</year>
      <volume>55</volume>
      <issue>2</issue>
      <pub-id pub-id-type="doi">10.1107/S1600576722002230</pub-id>
      <fpage>362</fpage>
      <lpage>369</lpage>
    </element-citation>
  </ref>
  <ref id="ref-Schumi-Marecek2024">
    <element-citation publication-type="article-journal">
      <person-group person-group-type="author">
        <name><surname>Schumi-Mareček</surname><given-names>David</given-names></name>
        <name><surname>Bertram</surname><given-names>Florian</given-names></name>
        <name><surname>Mikulı́k</surname><given-names>Petr</given-names></name>
        <name><surname>Varshney</surname><given-names>Devanshu</given-names></name>
        <name><surname>Novák</surname><given-names>Jiřı́</given-names></name>
        <name><surname>Kowarik</surname><given-names>Stefan</given-names></name>
      </person-group>
      <article-title>Millisecond X-ray reflectometry and neural network analysis: unveiling fast processes in spin coating</article-title>
      <source>Journal of Applied Crystallography</source>
      <year iso-8601-date="2024-04">2024</year><month>04</month>
      <volume>57</volume>
      <issue>2</issue>
      <uri>https://doi.org/10.1107/S1600576724001171</uri>
      <pub-id pub-id-type="doi">10.1107/S1600576724001171</pub-id>
      <fpage>314</fpage>
      <lpage>323</lpage>
    </element-citation>
  </ref>
  <ref id="ref-GlaviGenX">
    <element-citation publication-type="article-journal">
      <person-group person-group-type="author">
        <name><surname>Glavic</surname><given-names>Artur</given-names></name>
        <name><surname>Björck</surname><given-names>Matts</given-names></name>
      </person-group>
      <article-title>GenX 3: the latest generation of an established tool</article-title>
      <source>Journal of Applied Crystallography</source>
      <year iso-8601-date="2022-08">2022</year><month>08</month>
      <volume>55</volume>
      <issue>4</issue>
      <uri>https://doi.org/10.1107/S1600576722006653</uri>
      <pub-id pub-id-type="doi">10.1107/S1600576722006653</pub-id>
      <fpage>1063</fpage>
      <lpage>1071</lpage>
    </element-citation>
  </ref>
  <ref id="ref-NelsonRefnx">
    <element-citation publication-type="article-journal">
      <person-group person-group-type="author">
        <name><surname>Nelson</surname><given-names>Andrew R. J.</given-names></name>
        <name><surname>Prescott</surname><given-names>Stuart W.</given-names></name>
      </person-group>
      <article-title>refnx: neutron and X-ray reflectometry analysis in Python</article-title>
      <source>Journal of Applied Crystallography</source>
      <year iso-8601-date="2019-02">2019</year><month>02</month>
      <volume>52</volume>
      <issue>1</issue>
      <uri>https://doi.org/10.1107/S1600576718017296</uri>
      <pub-id pub-id-type="doi">10.1107/S1600576718017296</pub-id>
      <fpage>193</fpage>
      <lpage>200</lpage>
    </element-citation>
  </ref>
  <ref id="ref-Maranville2020">
    <element-citation>
      <person-group person-group-type="author">
        <name><surname>Maranville</surname><given-names>Brian Benjamin</given-names></name>
        <name><surname>Kienzle</surname><given-names>Paul</given-names></name>
        <string-name>Richardsheridan</string-name>
        <name><surname>Doucet</surname><given-names>Mathieu</given-names></name>
        <name><surname>Nelson</surname><given-names>Andrew</given-names></name>
        <name><surname>Hoogerheide</surname><given-names>David P.</given-names></name>
        <name><surname>Book</surname><given-names>Alexander</given-names></name>
        <name><surname>Ghose</surname><given-names>Ronnie</given-names></name>
      </person-group>
      <article-title>Reflectometry/refl1d: v0.8.13</article-title>
      <publisher-name>Zenodo</publisher-name>
      <year iso-8601-date="2020">2020</year>
      <pub-id pub-id-type="doi">10.5281/ZENODO.4329338</pub-id>
    </element-citation>
  </ref>
  <ref id="ref-Starostin2025">
    <element-citation publication-type="article-journal">
      <person-group person-group-type="author">
        <name><surname>Starostin</surname><given-names>Vladimir</given-names></name>
        <name><surname>Dax</surname><given-names>Maximilian</given-names></name>
        <name><surname>Gerlach</surname><given-names>Alexander</given-names></name>
        <name><surname>Hinderhofer</surname><given-names>Alexander</given-names></name>
        <name><surname>Tejero-Cantero</surname><given-names>Álvaro</given-names></name>
        <name><surname>Schreiber</surname><given-names>Frank</given-names></name>
      </person-group>
      <article-title>Fast and reliable probabilistic reflectometry inversion with prior-amortized neural posterior estimation</article-title>
      <source>Science Advances</source>
      <year iso-8601-date="2025">2025</year>
      <volume>11</volume>
      <issue>11</issue>
      <uri>https://www.science.org/doi/abs/10.1126/sciadv.adr9668</uri>
      <pub-id pub-id-type="doi">10.1126/sciadv.adr9668</pub-id>
      <fpage>eadr9668</fpage>
      <lpage></lpage>
    </element-citation>
  </ref>
</ref-list>
</back>
</article>
